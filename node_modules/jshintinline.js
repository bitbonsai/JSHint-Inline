/*
 * Copyright (c) 2013 Mauricio Wolff
 *
 * http://bitbonsai.mit-license.org/
 * 
 */

/* globals console, process, require, __dirname */

module.exports = function (file) {

    var fs = require('fs'),
        jshint = require('jshint').JSHINT,

        buffer = '',
        code,
        curfile = file || process.argv[2],
        curfilename,
        html,
        jsh_counter = 0,
        jsh_errors = [],
        line,
        match,
        options = { "browser": true, "globalstrict": true, "smarttabs": true, "debug": true, "strict": true, "unused": true, "undef": true, "curly": true },
        re = /<script\b[^>]*>([\s\S]*?)<\/script>/gm,
        script_lines = [],
        script_tags = 0,
        source = '';

    function errorLog (msg) {
        'use strict';

        console.log('✗ ' + msg);
    };

    if (!curfile) {
        errorLog('File needs to be saved before you can use JSHint-Inline.');
        return;
    }

    curfilename = (curfile.indexOf('/') > -1) ? curfile.split('/') : curfile.split('\\');
    curfilename = curfilename[curfilename.length - 1];

    html = fs.readFileSync(curfile, null).toString() || false;

    if (html) {
        html = html.toString();
    } else {
        errorLog("Couldn't get any content from this file... File: " + curfile);
        return;
    }

    html.split('\n').forEach(function (str, i) {
        'use strict';

        if (str.indexOf('<script') > -1) {
            script_lines.push(i);
        }
    });

    buffer += '[JSHint Inline: ' + curfile + ']\n\n';

    while (match = re.exec(html)){
        script_tags++;
        source = match[1];

        try {
            jshint(source, options);
        } catch(e) {}

        if (jshint.errors) {
            jshint.errors.forEach(function(e) {
                'use strict';

                // if the error is null, then we could not continue (too many errors)
                if (e === null) {
                  errorLog('Stopping, unable to continue. Too many errors.');
                  return;
                }

                // do some formatting if the error data is available
                if ("undefined" !== typeof e.raw) {
                    code = ' (' + e.code + ')';
                    line = e.line + script_lines[jsh_counter] - 1;
                    
                    jsh_errors.push('  ' + line + ',' + e.character + ': ' + e.reason + code);
                }
            });
        }
        jsh_counter++;
    }

    if (script_tags === 0) {
        errorLog('Stopping, unable to continue. This file does not have any <script> tag.');
        return;
    }

    if (!jsh_errors.length) {
        buffer += '✓ JSHint PASSED! 0 errors, [esc] to hide.\n';
    } else {
        var plural = (jsh_counter > 1) ? 's' : '';
        buffer += jsh_errors.join('\n');
        buffer += '\n\n';
        buffer += '✗ JSHint FAILED\n  ' + jsh_counter + ' warning'+ plural +'/error' + plural + ' detected.\n';
        buffer +=  '\n';
    }

    console.log(buffer);

}